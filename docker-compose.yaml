# ============================================
# logging
# ============================================
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    compress: "true"

# ============================================
# netwokrs
# ============================================
networks:
  restricted_wan:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.30.0/24

# ============================================
# secrets
# ============================================
secrets:
  cf_dns_api_token:
    file: ${SECRETS}/cf_dns_api_token
  traefik_basic_auth:
    file: ${SECRETS}/traefik_basic_auth
  cf_api_email:
    file: ${SECRETS}/cf_api_email
  pia_user:
    file: ${SECRETS}/pia_user
  pia_pass:
    file: ${SECRETS}/pia_pass
services:
  # ============================================
  # traefik - application proxy
  # ============================================
  traefik:
    image: traefik:v3.6.7
    container_name: traefik
    logging: *default-logging
    hostname: traefik
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.10
    ports:
      - "80:80"
      - "443:443"
    secrets:
      - cf_dns_api_token
      - traefik_basic_auth
      - cf_api_email
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - CF_DNS_API_TOKEN_FILE=/run/secrets/cf_dns_api_token
      - CF_API_EMAIL_FILE=/run/secrets/cf_api_email
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${CONFIG_ROOT}/traefik/certificates:/certificates:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=cloudflare"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.usersfile=/run/secrets/traefik_basic_auth"
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--api.dashboard=true"
      - "--log.level=info"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--providers.docker.allowEmptyServices=true"
      - "--entrypoints.websecure.http.tls.certresolver=cloudflare"
      # DNS Challenge Config
      - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cloudflare.acme.email=$$(cat /run/secrets/cf_api_email)"
      - "--certificatesresolvers.cloudflare.acme.storage=/certificates/acme.json"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
      # Health & Monitoring
      - "--ping=true"
      - "--ping.entrypoint=web"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:80/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 150M
          cpus: "0.5"
  # ============================================
  # gluetun - VPN gateway
  # ============================================
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    logging: *default-logging
    hostname: gluetun
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.90
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    secrets:
      - pia_user
      - pia_pass
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - VPN_SERVICE_PROVIDER=private internet access
      - OPENVPN_USER_FILE=/run/secrets/pia_user
      - OPENVPN_PASSWORD_FILE=/run/secrets/pia_pass
      - SERVER_REGIONS=${PIA_REGION}
    volumes:
      - ${CONFIG_ROOT:-.}/gluetun:/gluetun
    labels:
      - "traefik.enable=true"
      # Jellyseerr
      - "traefik.http.routers.jellyseerr.service=jellyseerr"
      - "traefik.http.routers.jellyseerr.tls=true"
      - "traefik.http.routers.jellyseerr.tls.certresolver=cloudflare"
      - "traefik.http.routers.jellyseerr.rule=Host(`jellyseerr.${DOMAIN}`)"
      - "traefik.http.routers.jellyseerr.entrypoints=websecure"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
      # Radarr
      - "traefik.http.routers.radarr.service=radarr"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.routers.radarr.tls.certresolver=cloudflare"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.rule=Host(`radarr.${DOMAIN}`)"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
  # ============================================
  # jellyfin - media server
  # ============================================
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    logging: *default-logging
    hostname: jellyfin
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.50
    ports:
      - "7359:7359/udp" # Client discovery (auto-detect on LAN)
      - "1900:1900/udp" # DLNA
    environment:
      - LOG_LEVEL=info
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${DOMAIN}
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/jellyfin:/config
      - ${CONFIG_ROOT:-.}/jellyfin/cache:/cache
      - ${MEDIA_SHARE}/media:/media:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN}`)"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
      - "traefik.http.routers.jellyfin.tls.certresolver=cloudflare"
    devices:
      - /dev/dri:/dev/dri
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:8096/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
  # ============================================
  # jellyseerr - request portal
  # ============================================
  jellyseerr:
    image: ghcr.io/fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    logging: *default-logging
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - PORT=5055
      - APP_URL=https://jellyseerr.${DOMAIN}
    volumes:
      - ${CONFIG_ROOT:-.}/jellyseerr:/app/config
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
  # ============================================
  # sonarr - tv show monitor
  # ============================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    logging: *default-logging
    hostname: sonarr
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.40
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/sonarr:/config
      - ${MEDIA_SHARE}/media:/media:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.${DOMAIN}`)"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "traefik.http.routers.sonarr.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:8989/sonarr/ping"]
      interval: 1m
      retries: 10
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
  # ============================================
  # prowlarr - indexer manager
  # ============================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    logging: *default-logging
    hostname: prowlarr
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.30
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/prowlarr:/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.${DOMAIN}`)"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      - "traefik.http.routers.prowlarr.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:9696/prowlarr/ping"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
  # ============================================
  # qbittorrent - torrent download client
  # ============================================
  qbit:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbit
    logging: *default-logging
    hostname: qbit
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.60
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - WEBUI_PORT=8085
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - ${CONFIG_ROOT:-.}/qbit:/config
      - ${MEDIA_SHARE}/media:/media:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbit.tls=true"
      - "traefik.http.routers.qbit.entrypoints=websecure"
      - "traefik.http.routers.qbit.rule=Host(`qbit.${DOMAIN}`)"
      - "traefik.http.services.qbit.loadbalancer.server.port=8085"
      - "traefik.http.routers.qbit.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:8085"]
      interval: 1m
      retries: 10
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
  # ============================================
  # radarr - movie monitor
  # ============================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    logging: *default-logging
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/radarr:/config
      - ${MEDIA_SHARE}/media:/media:rw
    restart: "unless-stopped"
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:7878"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
  # ============================================
  # flaresolverr - cloudflare bypass
  # ============================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    logging: *default-logging
    hostname: flaresolverr
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.80
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    labels:
      - "traefik.enable=false"
    restart: "unless-stopped"
    security_opt:
      - no-new-privileges:true
    healthcheck:
      # Actually test Chrome by making a solve request (catches Chrome crashes)
      test:
        [
          "CMD",
          "curl",
          "-sf",
          "-X",
          "POST",
          "-H",
          "Content-Type: application/json",
          "-d",
          '{"cmd":"request.get","url":"http://localhost:8191/","maxTimeout":30000}',
          "http://localhost:8191/v1",
        ]
      interval: 10m
      timeout: 60s
      retries: 2
      start_period: 2m
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
