# ============================================
# logging
# ============================================
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    compress: "true"
# ============================================
# netwokrs
# ============================================
networks:
  restricted_wan:
    external: true
# ============================================
# secrets
# ============================================
secrets:
  pia_user:
    file: ${SECRETS}/pia_user
  pia_pass:
    file: ${SECRETS}/pia_pass
services:
  # ============================================
  # gluetun - VPN gateway
  # ============================================
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    logging: *default-logging
    hostname: gluetun
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.90
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    secrets:
      - pia_user
      - pia_pass
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - VPN_SERVICE_PROVIDER=private internet access
      - OPENVPN_USER_FILE=/run/secrets/pia_user
      - OPENVPN_PASSWORD_FILE=/run/secrets/pia_pass
      - SERVER_REGIONS=${PIA_REGION}
    volumes:
      - ${CONFIG_ROOT:-.}/gluetun:/gluetun
    labels:
      - "traefik.enable=true"
      # seerr
      - "traefik.http.routers.seerr.service=seerr"
      - "traefik.http.routers.seerr.tls=true"
      - "traefik.http.routers.seerr.tls.certresolver=cloudflare"
      - "traefik.http.routers.seerr.rule=Host(`seerr.${DOMAIN}`)"
      - "traefik.http.routers.seerr.entrypoints=websecure"
      - "traefik.http.services.seerr.loadbalancer.server.port=5055"
      # Radarr
      - "traefik.http.routers.radarr.service=radarr"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.routers.radarr.tls.certresolver=cloudflare"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.rule=Host(`radarr.${DOMAIN}`)"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.1"
  # ============================================
  # jellyfin - media server
  # ============================================
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    logging: *default-logging
    hostname: jellyfin
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.50
    ports:
      - "7359:7359/udp" # Client discovery (auto-detect on LAN)
      - "1900:1900/udp" # DLNA
    environment:
      - LOG_LEVEL=info
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${DOMAIN}
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/jellyfin:/config:rw
      - ${CONFIG_ROOT:-.}/jellyfin/cache:/cache:rw
      - ${MEDIA_SHARE}/media:/media:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN}`)"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
      - "traefik.http.routers.jellyfin.tls.certresolver=cloudflare"
    devices:
      - /dev/dri:/dev/dri
      - /dev/dri/renderD128:/dev/dri/renderD128
      - /dev/dri/card0:/dev/dri/card0
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:8096/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "4.0"
  # ============================================
  # seerr - request portal
  # ============================================
  seerr:
    image: ghcr.io/seerr-team/seerr:latest
    init: true
    container_name: seerr
    logging: *default-logging
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - PORT=5055
      - APP_URL=https://seerr.${DOMAIN}
    volumes:
      - ${CONFIG_ROOT:-.}/seerr:/app/config
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
  # ============================================
  # sonarr - tv show monitor
  # ============================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    logging: *default-logging
    hostname: sonarr
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.40
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/sonarr:/config
      - ${MEDIA_SHARE}/media:/media:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.${DOMAIN}`)"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "traefik.http.routers.sonarr.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:8989/sonarr/ping"]
      interval: 1m
      retries: 10
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.1"
  # ============================================
  # prowlarr - indexer manager
  # ============================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    logging: *default-logging
    hostname: prowlarr
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.30
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/prowlarr:/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.${DOMAIN}`)"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      - "traefik.http.routers.prowlarr.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:9696/prowlarr/ping"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.1"
  # ============================================
  # jacket - torrent indexer
  # ============================================
  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: jackett
    logging: *default-logging
    hostname: jackett
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.20
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - AUTO_UPDATE=true
    volumes:
      - ${CONFIG_ROOT:-.}/jackett:/config
      - ${MEDIA_SHARE}/media/downloads:/downloads:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jackett.tls=true"
      - "traefik.http.routers.jackett.entrypoints=websecure"
      - "traefik.http.routers.jackett.rule=Host(`jackett.${DOMAIN}`)"
      - "traefik.http.services.jackett.loadbalancer.server.port=9117"
      - "traefik.http.routers.jackett.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:9117/UI/Dashboard"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
  # ============================================
  # qbittorrent - torrent download client
  # ============================================
  qbit:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbit
    logging: *default-logging
    hostname: qbit
    networks:
      restricted_wan:
        ipv4_address: 172.20.30.60
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
      - WEBUI_PORT=8085
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - ${CONFIG_ROOT:-.}/qbit:/config
      - ${MEDIA_SHARE}/media:/media:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbit.tls=true"
      - "traefik.http.routers.qbit.entrypoints=websecure"
      - "traefik.http.routers.qbit.rule=Host(`qbit.${DOMAIN}`)"
      - "traefik.http.services.qbit.loadbalancer.server.port=8085"
      - "traefik.http.routers.qbit.tls.certresolver=cloudflare"
    security_opt:
      - no-new-privileges:true
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:8085"]
      interval: 1m
      retries: 10
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.1"
  # ============================================
  # radarr - movie monitor
  # ============================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    logging: *default-logging
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - LOG_LEVEL=info
      - PUID=${USER_ID}
      - PGID=${GROUP_ID}
      - TZ=${TIMEZONE}
      - UMASK_SET=${USER_MASK}
    volumes:
      - ${CONFIG_ROOT:-.}/radarr:/config
      - ${MEDIA_SHARE}/media:/media:rw
    restart: "unless-stopped"
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:7878"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.1"
