name: Docker Compose Matrix Validation

on: push

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [traefik, arr, gitea, immich, gotify]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Test Environment
        run: |
          # Use .env.dev
          cp .env.dev .env

          # Create secrets
          mkdir -p ./secrets

          echo "dummy-cf-token-$(date +%s)" > ./secrets/cf_dns_api_token
          echo "testuser:$(openssl passwd -apr1 testpass123)" > ./secrets/traefik_basic_auth
          echo "test@example.com" > ./secrets/cf_api_email
          echo "test-pia-user" > ./secrets/pia_user
          echo "test-pia-pass" > ./secrets/pia_pass
          echo "postgres" > ./secrets/pg_user
          echo "postgres-pass-$(date +%s)" > ./secrets/pg_pas
          echo "gitea-key-$(openssl rand -hex 16)" > ./secrets/gitea_key
          echo "gitea-token-$(openssl rand -hex 32)" > ./secrets/gitea_token

          chmod 600 ./secrets/*

      - name: Validate ${{ matrix.service }}/docker-compose.yaml
        run: |
          echo "üîç Validating ${{ matrix.service }}..."
          docker compose \
            -f ${{ matrix.service }}/docker-compose.yaml \
            --env-file .env \
            config
          echo "‚úÖ ${{ matrix.service }} is valid!"
